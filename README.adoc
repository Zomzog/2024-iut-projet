== Sujet

Le but de ce projet est de cr√©er 3 services pour faire de la gestion de stock magasin.

Les trois services sont les suivants :

- Products : un r√©f√©rentiel de produit.
- Stores : un r√©f√©rentiel de magasin avec les produits en stock.
- Gateway : un service qui permet de faire proxy devant les deux autres pour g√©rer la partie s√©curit√©.

Chaque service a sa propre sp√©cification, des contraintes sont √† respecter pour chaque service. +
Elles ne sont pas imp√©ratives,
par exemple s'il est demand√© une base de donn√©e h2, il vaut mieux une version HashMap en m√©moire qu'un service qui ne fonctionne pas.

La liste des APIs doit inclure au minimum les endpoints demand√©s, mais il est possible d'en ajouter d'autres si n√©cessaire.

== Products ‚úÖ

Le service Products est un service qui permet de g√©rer des familles de produits et les produits associ√©s.

Contraintes :

* Ce service doit fournir une impl√©mentation de la "base de donn√©e" :
** en h2 par default,
** avec une hashmap si le profile DEV est activ√©.
* Ce service ne doit pas utiliser les annotations `@Compoment`, `@Service`, `@Repository`, `@Controller`.
* Ce service doit avec une architecture en couche :
** La couche `controlleur` qui fait la validation des donn√©es et la transformation DTO -> Format interne.
** La couche `service` qui fait la logique m√©tier.
** La couche `repository` qui fait la gestion de la base de donn√©e (√ßa peut √™tre le repository JPA).

=== Famille üü†

Une famille se pr√©sente sous la forme suivante :

[source,json]
----
{
  "id": "9a852ad2-4b0a-4f74-8e23-5305b733c263",
  "name": "Bike",
  "description": "All kind of bikes"
}
----

Son ID est un UUID qui sera choisi par le service lors de la cr√©ation de la famille, jamais par l'utilisateur.

Le nom d'une famille est unique, mais la description ne l'est pas.

Le nom doit faire entre 3 et 30 caract√®res.

La description doit faire entre 5 et 100 caract√®res.

Il faut fournir les endpoints suivants :

==== `POST /api/v1/families` : Permet de cr√©er une famille

L'API doit r√©pondre :

- `201` avec la famille cr√©√©e en body.
- `400` si les donn√©es sont invalides.
- `409` s'il y a un conflit de nom.

==== `GET /api/v1/families` : Permet de r√©cup√©rer toutes les familles

Retourne la liste des familles enregistr√©es.

==== `GET /api/v1/families/{id}` : Permet de r√©cup√©rer une famille par son ID

L'API doit r√©pondre :

- `200` avec la famille correspondante √† l'ID si elle existe.
- `400` si le format de l'id est invalide.
- `404` si la famille n'existe pas.

==== `PUT /api/v1/families/{id}` : Permet de mettre √† jour une famille

L'API doit r√©pondre :

- `200` avec la famille mise √† jour.
- `400` si les donn√©es sont invalides.
- `409` s'il y a un conflit de nom.

==== `DELETE /api/v1/families/{id}` : Permet de supprimer une famille

On ne peut supprimer une famille que s'il n'y a plus de produit li√© √† elle.

L'API doit r√©pondre :

- `204` si la famille est supprim√©e.
- `409` si des produits sont encore li√©s √† elle.
- `404` si la famille n'existe pas.

=== Product

Un produit se pr√©sente sous la forme suivante :

[source,json]
----
{
  "id": "a6efa614-0235-4180-bbe7-0ff30f3bb858",
  "name": "RC 500",
  "description": "VELO ROUTE CYCLOTOURISTE",
  "price": {
    "amount": 875,
    "currency": "EUR"
  },
  "family": {
    "id": "9a852ad2-4b0a-4f74-8e23-5305b733c263",
    "name": "Bike",
    "description": "All kind of bikes"
  }
}
----

L'ID est un UUID g√©n√©r√© par le service lors de la cr√©ation du produit, jamais pas l'utilisateur.

Le nom d'un produit doit faire entre 2 et 20 caract√®res.

La description doit faire entre 5 et 100 caract√®res ou √™tre nulle.

Le prix est un objet avec un montant positif et une devise sur 3 caract√®res alphab√©tique majuscule (ex: EUR et non eur).

La famille ne peut pas √™tre nulle, ni modifi√©e par l'API des produits.

Il faut fournir les endpoints suivants :

==== `POST /api/v1/products` : Permet de cr√©er un produit

L'API doit r√©pondre :

- `201` avec le produit cr√©√©.
- `400` si les donn√©es sont invalides ou si la famille n'existe pas.

==== `GET /api/v1/products?familyname=Bike&minprice=100&maxprice=200` : Permet de r√©cup√©rer tous les produits

Les crit√®res de filtrage `familyname`, `minprice` et `maxprice` sont tous optionnels.

Il faut respecter la r√®gle: `0 < minprice < maxprice`

L'API doit retourner :

- `200` avec la liste des produits correspondants aux crit√®res.
- `400` si les crit√®res de filtrages sont incoh√©rents.

==== `GET /api/v1/products/{id}` : Permet de r√©cup√©rer un produit par son ID

L'API doit r√©pondre :

- `200` avec le produit correspondant √† l'ID s'il existe.
- `400` si le format de l'id est invalide.
- `404` si le produit n'existe pas.

==== `PUT /api/v1/products/{id}` : Permet de mettre √† jour un produit

Permet de mettre √† jour un produit. +
Ce endpoint permet aussi de changer la famille d'un produit.

L'API doit r√©pondre :

- `200` avec le produit mise √† jour.
- `400` si les donn√©es sont invalides ou que la nouvelle famille n'existe pas.

==== `DELETE /api/v1/products/{id}` : Permet de supprimer un produit

Permet de supprimer un produit s'il n'est plus en stock dans aucun magasin (i.e. n'existe pas pour le magasin ou stock=0).

Avant la suppression, tous les stocks √† 0 du magasin doivent √™tre supprim√©s.

- `204` si le produit est supprim√©.
- `400` si l'id est invalide.
- `409` s'il existe encore du stock pour ce produit.

== Stores

Le service Stores est un service qui permet de g√©rer les informations de contact, les magasins et leur stock des produits.

Contraintes :

* Ce service doit fournir une impl√©mentation de la "base de donn√©e" en h2.
* Le service ne peut utiliser que le client http `WebClient`.
* La gestion des erreurs doit passer par un `ControllerAdvice`.

=== Contact

Un contact se pr√©sente sous la forme suivante :

[source,json]
----
{
  "id": 1,
  "email": "my@email.com",
  "phone": "0123456789",
  "address": {
    "street": "Rue truc",
    "city": "Nantes",
    "postalCode": "44300"
  }
}
----

L'ID est un entier g√©n√©r√© par la base de donn√©e.

L'email doit avoir un format valide.

Le t√©l√©phone doit √™tre un num√©ro de t√©l√©phone valide (10 chiffres).

La rue doit faire entre 5 et 50 caract√®res.

La ville doit faire entre 1 et 30 caract√®res.

Le code postal doit √™tre un code postal valide (5 chiffres).

Il faut fournir les endpoints suivants :

==== `POST /api/v1/contacts` : Permet de cr√©er un contact

L'API doit r√©pondre :

- `201` avec le contact cr√©√© en body.
- `400` si les donn√©es sont invalides.

==== `GET /api/v1/contacts?city=Nantes` : Permet de r√©cup√©rer tous les contacts

La liste des contacts optionnellement filtr√©e par la ville.

==== `GET /api/v1/contacts/{id}` : Permet de r√©cup√©rer un contact par son ID

L'API doit r√©pondre :

- `200` avec le contact correspondant √† l'ID s'il existe.
- `400` si le format de l'id est invalide.
- `404` si le contact n'existe pas.

==== `PUT /api/v1/contacts/{id}` : Permet de mettre √† jour un contact

Lors d'un update de contact,
on ne peut pas changer en m√™me temps l'email et le t√©l√©phone.

L'API doit r√©pondre :

- `200` avec le contact est mise √† jour.
- `400` si les donn√©es sont invalides.

==== `DELETE /api/v1/contacts/{id}` : Permet de supprimer un contact

Supprime un contact s'il n'est plus li√© √† aucun magasin.

- `204` si le contact est supprim√©.
- `400` si l'id est invalide.
- `409` s'il existe un magasin li√©.

=== Store

Un magasin se pr√©sente sous la forme suivante :

[source,json]
----
{
  "id": 1,
  "name": "Atlantis",
  "contact": {
    "id": 1,
    "email": "my@email.com",
    "phone": "0123456789",
    "address": {
      "street": "Rue truc",
      "city": "Nantes",
      "postalCode": "44300"
    }
  },
  "products": [
    {
      "id": "e437f62a-432e-4aef-a440-6c86d3b09901",
      "name": "RC 500",
      "quantity": 1
    }
  ]
}
----

L'ID est un entier g√©n√©r√© par la base de donn√©e.

Le nom doit faire entre 3 et 30 caract√®res.

Le contact ne peut pas √™tre nul.

La liste de produits ne peut pas √™tre nulle, mais peut √™tre vide. +
Elle ne peut pas √™tre initialis√©e avec le magasin. +
Elle ne peut pas contenir de doublons.

Le nom du produit doit √™tre coh√©rent avec le contenu du service product.

Il faut fournir les endpoints suivants :

==== `POST /api/v1/stores` : Permet de cr√©er un magasin

Cette API permet de cr√©er un magasin.
Si le contact n'existe pas, il est cr√©√©. S'il existe, il est utilis√© sans mise √† jour.

On ne peut pas initialiser la liste de produits avec cette API.
Si elle est fournie, elle doit √™tre ignor√©e.

On ne peut pas mettre √† jour un magasin avec cette API.

L'API doit r√©pondre :

- `201` avec le magasin cr√©√©.
- `400` si les donn√©es sont invalides.

==== `GET /api/v1/stores` : Permet de r√©cup√©rer tous les magasins

Cette API permet de r√©cup√©rer la liste des magasins tri√©e par nom croissant (i.e. a->z).

==== `GET /api/v1/stores/{id}` : Permet de r√©cup√©rer un magasin par son ID

L'API doit r√©pondre :

- `200` avec le magasin correspondant √† l'ID s'il existe.
- `400` si le format de l'id est invalide.
- `404` si le contact n'existe pas.

==== `PUT /api/v1/stores/{id}` : Permet de mettre √† jour un magasin

Cette API permet de mettre √† jour les informations d'un magasin,
mais pas la liste de produits.

Elle permet de changer le contact du magasin.

L'API doit r√©pondre :

- `200` avec le magasin mise √† jour.
- `400` si les donn√©es sont invalides.

==== `DELETE /api/v1/stores/{id}` : Permet de supprimer un magasin

Supprime un magasin et les produits qui lui sont li√©s.

L'API doit r√©pondre :

- `204` si le magasin est supprim√©.
- `400` si l'id est invalide.
- `404` si le magasin n'existe pas.

=== Stock

Il est possible de g√©rer les stocks des produits dans les magasins avec trois APIs.

==== `POST /api/v1/stores/{storeId}/products/{productId}/add?quantity=2` : Permet d'ajouter une quantit√© de produit au stock d'un magasin

Le param√®tre `quantity` est optionnel, mais doit √™tre positif s'il est fourni.

Si le param√®tre `quantity` n'est pas fourni, il est initialis√© √† 1.

Si le produit n'existe pas dans le magasin, il faut v√©rifier qu'il existe puis l'ajouter.

L'API doit r√©pondre :

- `200` avec le produit mis √† jour.
- `400` si les donn√©es sont invalides.
- `404` si le magasin n'existe pas.

==== `POST /api/v1/stores/{storeId}/products/{productId}/remove?quantity=2` : Permet de retirer une quantit√© de produit du stock d'un magasin

Le param√®tre `quantity` est optionnel, mais doit √™tre positif s'il est fourni.

Si le param√®tre `quantity` n'est pas fourni, il est initialis√© √† 1.

L'API doit r√©pondre :

- `200` avec le produit mis √† jour.
- `400` si les donn√©es sont invalides.
- `404` si le produit n'est pas dans le magasin ou le magasin n'existe pas.
- `409` si le stock final est inf√©rieur √† 0.

==== `DELETE /api/v1/stores/{storeId}/products` : Permet de retirer un produit du stock d'un magasin

Cette API prend en body une liste de produits √† retirer du stock.

[source,json]
----
[
"e437f62a-432e-4aef-a440-6c86d3b09901",
 "9a852ad2-4b0a-4f74-8e23-5305b733c263"
]
----

Si un produit n'est pas dans le magasin, il est ignor√©.

L'API doit r√©pondre :

- `204` si les produits sont retir√©s ou ignor√©s.
- `400` si les donn√©es sont invalides ou si un produit est en double dans la liste.
- `404` si le magasin n'existe pas.

== Gateway

Le service Gateway est un service qui permet de faire proxy devant les deux autres services. +
C'est-√†-dire qu'il ne fait que rediriger les requ√™tes vers les services appropri√©s apr√®s avoir v√©rifi√© l'authentification de l'utilisateur. +
Lors de la redirection, il doit ajouter un header `X-User` avec le login de l'utilisateur.

Les services `Products` et `Stores` doivent filtrer les requ√™tes,
avec le code le plus commun possible (entre endpoint, voire entre services),
et ne laisser passer que celles avec ce header.

Pour qu'un utilisateur puisse appeler les endpoints autres que les ajouts et suppression de stock,
il doit avoir le role `ADMIN`

De base le service doit avoir un utilisateur `ADMIN` au login `ADMIN/ADMIN`

Le endpoint `POST /api/v1/user` permet de cr√©er un utilisateur avec le body suivant :

[source,json]
----
{
  "login": "user",
  "password": "password",
  "isAdmin": false
}
----

Contraintes :

* Le service doit fournir une gestion du `UserDetail` :
** In memory si la property `gateway.security=inmemory`.
** En base de donn√©e sinon.

== Test

Pensez √† en faire au moins un peu.
